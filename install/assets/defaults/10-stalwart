#!/command/with-contenv bash

CONFIG_FILE=${CONFIG_FILE:-"config.toml"}
CONFIG_PATH=${CONFIG_PATH:-"/config/"}
DATA_PATH=${DATA_PATH:-"/data/"}
LOG_FILE=${LOG_FILE:-"log.log"}
LOG_LEVEL=${LOG_LEVEL:-"INFO"}
LOG_TYPE=${LOG_TYPE:-"FILE"}
LOG_PATH=${LOG_PATH:-"/logs/"}
MODE=${MODE:-"SMTP"}
SETUP_TYPE=${SETUP_TYPE:-"AUTO"}

ENABLE_SIEVE=${ENABLE_SIEVE:-"FALSE"}
ENABLE_TLS=${ENABLE_TLS:-"TRUE"}

SERVER_NAME=${SERVER_NAME:-"${CONTAINER_NAME}"}
SERVER_SOCKET_NODELAY=${SERVER_SOCKET_NODELAY:-"TRUE"}
SERVER_SOCKET_REUSE_ADDR=${SERVER_SOCKET_REUSE_ADDR:-"TRUE"}
SERVER_SOCKET_BACKLOG=${SERVER_SOCKET_BACKLOG:-"1024"}
GLOBAL_SHARED_MAP=${GLOBAL_SHARED_MAP:-"{shard = 32, capacity = 10}"}

TLS_DEFAULT_CERT_FILE=${TLS_DEFAULT_CERT_FILE:-"/certs/stalwart.crt"}
TLS_DEFAULT_KEY_FILE=${TLS_DEFAULT_KEY_FILE:-"/certs/stalwart.key"}
RELOAD_ON_CERT_CHANGE=${RELOAD_ON_CERT_CHANGE:-"TRUE"} ## TODO

SERVER_USER=${SERVER_USER:-"stalwart"}
SERVER_GROUP=${SERVER_GROUP:-"stalwart"}

REPORTS_PATH=${REPORTS_PATH:-"${DATA_PATH}/reports"}
REPORTS_HASH=${REPORTS_HASH:-"64"}

SMTP_SESSION_TIMEOUT=${SMTP_SESSION_TIMEOUT:-"5m"}
SMTP_SESSION_TRANSFER_LIMIT=${SMTP_SESSION_TRANSFER_LIMIT:-"2621440000"}
SMTP_SESSION_DURATION=${SMTP_SESSION_DURATION:-"10m"}

SMTP_SESSION_EHLO_REQUIRE=${SMTP_SESSION_EHLO_REQUIRE:-"TRUE"}
SMTP_SESSION_REJECT_NON_FQDN=${SMTP_SESSION_REJECT_NON_FQDN:-"[ { if = "listener", eq = "smtp", then = true} { else = false } ]"}

SMTP_SESSION_EXTENSIONS_PIPELINING=${SMTP_SESSION_EXTENSIONS_PIPELINING:-"TRUE"}
SMTP_SESSION_EXTENSIONS_CHUNKING=${SMTP_SESSION_EXTENSIONS_CHUNKING:-"TRUE"}
SMTP_SESSION_EXTENSIONS_REQUIRETLS=${SMTP_SESSION_EXTENSIONS_REQUIRETLS:-"TRUE"}
SMTP_SESSION_EXTENSIONS_NO_SOLICITING=${SMTP_SESSION_EXTENSIONS_NO_SOLICITING:-" "}
SMTP_SESSION_EXTENSIONS_DSN=${SMTP_SESSION_EXTENSIONS_DSN:-"[ { if = "authenticated-as", ne = "", then = true}, { else = false } ]"}
SMTP_SESSION_EXTENSIONS_EXPN=${SMTP_SESSION_EXTENSIONS_EXPN:-"[ { if = "authenticated-as", ne = "", then = true}, { else = false } ]"}
SMTP_SESSION_EXTENSIONS_VRFY=${SMTP_SESSION_EXTENSIONS_VRFY:-"[ { if = "authenticated-as", ne = "", then = true}, { else = false } ]"}
SMTP_SESSION_EXTENSIONS_FUTURE_RELEASE=${SMTP_SESSION_EXTENSIONS_FUTURE_RELEASE:-"[ { if = "authenticated-as", ne = "", then = "7d"}, { else = false } ]"}
SMTP_SESSION_EXTENSIONS_DELIVER_BY=${SMTP_SESSION_EXTENSIONS_DELIVER_BY:-"[ { if = "authenticated-as", ne = "", then = "15d"}, { else = false } ]"}
SMTP_SESSION_EXTENSIONS_MT_PRIORITY=${SMTP_SESSION_EXTENSIONS_MT_PRIORITY:-"[ { if = "authenticated-as", ne = "", then = "mixer"}, { else = false } ]"}

SMTP_SESSION_AUTH_MECHANISMS=${SMTP_SESSION_AUTH_MECHANISMS:-"[ { if = "listener", ne = "smtp", then = ["plain", "login"]}, { else = [] } ]"}
SMTP_SESSION_AUTH_DIRECTORY=${SMTP_SESSION_AUTH_DIRECTORY:-"[ { if = "listener", ne = "smtp", then = "default" }, { else = false } ]"}
SMTP_SESSION_AUTH_REQUIRE=${SMTP_SESSION_AUTH_REQUIRE:-"[ { if = "listener", ne = "smtp", then = true}, { else = false } ]"}
SMTP_SESSION_AUTH_ALLOW_PLAIN_TEXT=${SMTP_SESSION_AUTH_ALLOW_PLAIN_TEXT:-"FALSE"}
SMTP_SESSION_AUTH_ERRORS=${SMTP_SESSION_AUTH_ERRORS:-""}

SMTP_SESSION_AUTH_ERRORS_TOTAL=${SMTP_SESSION_AUTH_ERRORS_TOTAL:-"3"}
SMTP_SESSION_AUTH_ERRORS_WAIT=${SMTP_SESSION_AUTH_ERRORS_WAIT:-"5s"}

SMTP_SESSSION_MAIL_=${SMTP_SESSION_MAIL_:-""}
SMTP_SESSSION_MAIL_=${SMTP_SESSION_MAIL_:-""}

SMTP_SESSSION_RCPT_SCRIPT=${SMTP_SESSION_RCPT_SCRIPT:-""}
SMTP_SESSSION_RCPT_RELAY=${SMTP_SESSION_RCPT_RELAY:-"[ { if = "authenticated-as", ne = "", then = true }, { else = false } ]"}
SMTP_SESSSION_RCPT_REWRITE=${SMTP_SESSION_RCPT_REWRITE:-""}
SMTP_SESSSION_RCPT_MAX_RECIPIENTS=${SMTP_SESSION_RCPT_MAX_RECIPIENTS:-"25"}
SMTP_SESSSION_RCPT_DIRECTORY=${SMTP_SESSION_RCPT_DIRECTORY:-"default"}

SMTP_SESSSION_RCPT_ERRORS_TOTAL=${SMTP_SESSION_RCPT_ERRORS_TOTAL:-"5"}
SMTP_SESSSION_RCPT_ERRORS_WAIT=${SMTP_SESSION_RCPT_ERRORS_WAIT:-"5s"}

SMTP_SESSSION_DATA_SCRIPT=${SMTP_SESSION_DATA_SCRIPT:-"[ { if = "authenticated-as", eq = "", then = "spam-filter"}, { else = "track-replies" } ]"}

SMTP_SESSSION_DATA_LIMITS_MESSAGES=${SMTP_SESSION_DATA_LIMITS_MESSAGES:-"10"}
SMTP_SESSSION_DATA_LIMITS_SIZE=${SMTP_SESSION_DATA_LIMITS_SIZE:-"104857600"}
SMTP_SESSSION_DATA_LIMITS_RECEIVED_HEADERS=${SMTP_SESSION_DATA_LIMITS_RECEIVED_HEADERS:-"50"}

SMTP_SESSSION_THROTTLE_=${SMTP_SESSION_THROTTLE_:-""} ## TODO Need to support multiple blocks
SMTP_SESSSION_THROTTLE_=${SMTP_SESSION_THROTTLE_:-""} ## TODO Need to support multiple blocks
SMTP_SESSSION_THROTTLE_=${SMTP_SESSION_THROTTLE_:-""} ## TODO Need to support multiple blocks
SMTP_SESSSION_THROTTLE_=${SMTP_SESSION_THROTTLE_:-""} ## TODO Need to support multiple blocks
SMTP_SESSSION_THROTTLE_=${SMTP_SESSION_THROTTLE_:-""} ## TODO Need to support multiple blocks
SMTP_SESSSION_THROTTLE_=${SMTP_SESSION_THROTTLE_:-""} ## TODO Need to support multiple blocks
SMTP_SESSSION_THROTTLE_=${SMTP_SESSION_THROTTLE_:-""} ## TODO Need to support multiple blocks

SMTP_RESOLVER_TYPE=${SMTP_RESOLVER_TYPE:-"system"}
SMTP_RESOLVER_PRESERVE_INTERMEDIATES=${SMTP_RESOLVER_PRESERVE_INTERMEDIATES:-"FALSE"}
SMTP_RESOLVER_CONCURRENCY=${SMTP_RESOLVER_CONCURRENCY:-"2"}
SMTP_RESOLVER_TIMEOUT=${SMTP_RESOLVER_TIMEOUT:-"5s"}
SMTP_RESOLVER_ATTEMPTS=${SMTP_RESOLVER_ATTEMPTS:-"2"}
SMTP_RESOLVER_TRY_TCP_ON_ERROR=${SMTP_RESOLVER_TRY_TCP_ON_ERROR:-"TRUE"}
SMTP_RESOLVER_PUBLIC_SUFFIX=${SMTP_RESOLVER_PUBLIC_SUFFIX:-"["https://publicsuffix.org/list/public_suffix_list.dat", "file://${CONFIG_PATH}/spamfilter/maps/suffix_list.dat.gz"]"} ## TODO This path is bad and also should be a proper CSV

SMTP_RESOLVER_CACHE_TXT=${SMTP_RESOLVER_CACHE_TXT:-"2048"}
SMTP_RESOLVER_CACHE_MX=${SMTP_RESOLVER_CACHE_MX:-"1024"}
SMTP_RESOLVER_CACHE_IPV4=${SMTP_RESOLVER_CACHE_IPV4:-"1024"}
SMTP_RESOLVER_CACHE_IPV6=${SMTP_RESOLVER_CACHE_IPV6:-"1024"}
SMTP_RESOLVER_CACHE_PTR=${SMTP_RESOLVER_CACHE_PTR:-"1024"}
SMTP_RESOLVER_CACHE_TLSA=${SMTP_RESOLVER_CACHE_TLSA:-"1024"}
SMTP_RESOLVER_CACHE_MTA_STS=${SMTP_RESOLVER_CACHE_MTA_STS:-"1024"}

SMTP_AUTH_IPREV_VERIFY=${SMTP_AUTH_IPREV_VERIFY:-"[ { if = "listener", eq = "smtp", then = "relaxed" }, { else = "disable" } ]"}
SMTP_AUTH_DKIM_VERIFY=${SMTP_AUTH_DKIM_VERIFY:-"relaxed"}
SMTP_AUTH_DKIM_SIGN=${SMTP_AUTH_DKIM_SIGN:-"[ { if = "listener", ne = "smtp", then = ["rsa"] }, { else = [] } ]"}
SMTP_AUTH_SPF_VERIFY_EHLO=${SMTP_AUTH_SPF_VERIFY_EHLO:-"[ { if = "listener", eq = "smtp", then = "relaxed" }, { else = "disable" } ]"}
SMTP_AUTH_SPF_VERIFY_MAIL_FROM=${SMTP_AUTH_SPF_VERIFY_MAIL_FROM:-"[ { if = "listener", eq = "smtp", then = "relaxed" }, { else = "disable" } ]"}
SMTP_AUTH_ARC_VERIFY=${SMTP_AUTH_ARC_VERIFY:-"relaxed"}
SMTP_AUTH_ARC_SEAL=${SMTP_AUTH_ARC_SEAL:-"["rsa"]"}

SMTP_AUTH_DMARC_VERIFY=${SMTP_AUTH_DMARC_VERIFY:-"[ { if = "listener", eq = "smtp", then = "relaxed" }, { else = "disable" } ]"}

DIRECTORY_LDAP_DEFAULT_BIND_DN=${DIRECTORY_LDAP_DEFAULT_BIND_DN:-"cn=serviceuser,ou=svcaccts,dc=example,dc=org"}
DIRECTORY_LDAP_DEFAULT_BIND_SECRET=${DIRECTORY_LDAP_DEFAULT_BIND_SECRET:-"mysecret"}

DIRECTORY_LDAP_DEFAULT_CACHE_ENTRIES=${DIRECTORY_LDAP_DEFAULT_CACHE_ENTRIES:-"500"}
DIRECTORY_LDAP_DEFAULT_CACHE_TTL=${DIRECTORY_LDAP_DEFAULT_CACHE_TTL:-"{positive = '1h', negative = '10m'}"}

DIRECTORY_LDAP_DEFAULT_OPTIONS_CATCH_ALL=${DIRECTORY_LDAP_DEFAULT_OPTIONS_CATCH_ALL:-"TRUE"}
DIRECTORY_LDAP_DEFAULT_OPTIONS_SUBADDRESSING=${DIRECTORY_LDAP_DEFAULT_OPTIONS_SUBADDRESSING:-"TRUE"}
DIRECTORY_LDAP_DEFAULT_OPTIONS_SUPERUSER_GROUP=${DIRECTORY_LDAP_DEFAULT_OPTIONS_SUPERUSER_GROUP:-"superusers"}

DIRECTORY_LDAP_DEFAULT_POOL_MAX_CONNECTIONS=${DIRECTORY_LDAP_DEFAULT_POOL_MAX_CONNECTIONS:-"10"}
DIRECTORY_LDAP_DEFAULT_POOL_MIN_CONNECTIONS=${DIRECTORY_LDAP_DEFAULT_POOL_MIN_CONNECTIONS:-"0"}
DIRECTORY_LDAP_DEFAULT_POOL_MAX_LIFETIME=${DIRECTORY_LDAP_DEFAULT_POOL_MAX_LIFETIME:-"30m"}
DIRECTORY_LDAP_DEFAULT_POOL_IDLE_TIMEOUT=${DIRECTORY_LDAP_DEFAULT_POOL_IDLE_TIMEOUT:-"10m"}
DIRECTORY_LDAP_DEFAULT_POOL_CONNECT_TIMEOUT=${DIRECTORY_LDAP_DEFAULT_POOL_CONNECT_TIMEOUT:-"30s"}

DIRECTORY_LDAP_DEFAULT_FILTER_NAME=${DIRECTORY_LDAP_DEFAULT_FILTER_NAME:-"(&(|(objectClass=posixAccount)(objectClass=posixGroup))(uid=?))"}
DIRECTORY_LDAP_DEFAULT_FILTER_EMAIL=${DIRECTORY_LDAP_DEFAULT_FILTER_EMAIL:-"(&(|(objectClass=posixAccount)(objectClass=posixGroup))(|(mail=?)(mailAlias=?)(mailList=?)))"}
DIRECTORY_LDAP_DEFAULT_FILTER_VERIFY=${DIRECTORY_LDAP_DEFAULT_FILTER_VERIFY:-"(&(|(objectClass=posixAccount)(objectClass=posixGroup))(|(mail=*?*)(mailAlias=*?*)))"}
DIRECTORY_LDAP_DEFAULT_FILTER_EXPAND=${DIRECTORY_LDAP_DEFAULT_FILTER_EXPAND:-"(&(|(objectClass=posixAccount)(objectClass=posixGroup))(mailList=?))"}
DIRECTORY_LDAP_DEFAULT_FILTER_DOMAINS=${DIRECTORY_LDAP_DEFAULT_FILTER_DOMAINS:-"(&(|(objectClass=posixAccount)(objectClass=posixGroup))(|(mail=*@?)(mailAlias=*@?)))"}

DIRECTORY_LDAP_DEFAULT_OBJECT_CLASSES_USER=${DIRECTORY_LDAP_DEFAULT_OBJECT_CLASSES_USER:-"posixAccount"}
DIRECTORY_LDAP_DEFAULT_OBJECT_CLASSES_GROUP=${DIRECTORY_LDAP_DEFAULT_OBJECT_CLASSES_GROUP:-"posixGroup"}

DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_NAME=${DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_NAME:-"uid"}
DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_DESCRIPTION=${DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_DESCRIPTION:-"["principalName", "description"]"}
DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_SECRET=${DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_SECRET:-"userPassword"}
DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_GROUPS=${DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_GROUPS:-"["memberOf", "otherGroups"]"}
DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_EMAIL=${DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_EMAIL:-"mail"}
DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_EMAIL_ALIAS=${DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_EMAIL_ALIAS:-"mailAlias"}
DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_QUOTA=${DIRECTORY_LDAP_DEFAULT_ATTRIBUTES_QUOTA:-"diskQuota"}

DIRECTORY_LDAP_DEFAULT_TYPE=${DIRECTORY_LDAP_DEFAULT_TYPE:-"ldap"}
DIRECTORY_LDAP_DEFAULT_ADDRESS=${DIRECTORY_LDAP_DEFAULT_ADDRESS:-"ldap://ldap:389"}
DIRECTORY_LDAP_DEFAULT_BASE_DN=${DIRECTORY_LDAP_DEFAULT_BASE_DN:-"dc=example,dc=org"}